name: Code Quality Checks

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
    - name: Validate copilot-instructions.md compliance
      run: |
        echo "ğŸ¤– Enforcing GitHub Copilot Instructions across ALL Rust files"
        echo "ğŸ“‹ Reference: .github/copilot-instructions.md"
        echo "ğŸ” Scanning: src/, bin/, crates/, examples/, tests/, benches/"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
    - name: Initialize failure tracking
      run: echo "FAILED_CHECKS=" >> $GITHUB_ENV
        
    - name: Check for hardcoded values
      run: |
        echo "1ï¸âƒ£ Checking for hardcoded magic numbers..."
        if grep -r --include="*.rs" -E '\b[0-9]{3,}\b' . --exclude-dir=target && ! grep -r --include="*.rs" 'const.*=' . --exclude-dir=target; then
          echo "âŒ Found potential magic numbers. Use constants instead."
          echo "FAILED_CHECKS=${{ env.FAILED_CHECKS }} hardcoded-values" >> $GITHUB_ENV
        else
          echo "âœ… No hardcoded values found"
        fi
        
    - name: Check variable naming conventions
      run: |
        echo "2ï¸âƒ£ Checking variable naming conventions..."
        if grep -r --include="*.rs" -E 'let\s+[a-z]*[aeiou]*[bcdfghjklmnpqrstvwxyz]{3,}[aeiou]*[bcdfghjklmnpqrstvwxyz]\s*=' . --exclude-dir=target | grep -E '(usr|addr|cfg|mgr|ctx|impl|proc)'; then
          echo "âŒ Found potential abbreviations in variable names"
          echo "Use full descriptive names as per copilot-instructions.md"
          echo "FAILED_CHECKS=${{ env.FAILED_CHECKS }} variable-naming" >> $GITHUB_ENV
        else
          echo "âœ… Variable naming looks good"
        fi
        
    - name: Check for inline variables in macros
      run: |
        echo "3ï¸âƒ£ Checking log macro formatting..."
        violations=$(grep -r --include="*.rs" -E '(info!|debug!|warn!|error!|println!)\s*\([^)]*\{\}' . --exclude-dir=target | \
          grep -v -E '\w+\.\w+\(\)' || true)
        if [ -n "$violations" ]; then
          echo "âŒ Found {} placeholders in log macros. Use inline variables instead."
          echo "$violations"
          echo "Example: info!(\"User {user_id} status {status}\") instead of info!(\"User {} status {}\", user_id, status)"
          echo "Note: Function calls like variable.method() are allowed as exceptions"
          echo "FAILED_CHECKS=${{ env.FAILED_CHECKS }} log-macros" >> $GITHUB_ENV
        else
          echo "âœ… Log macro usage looks good"
        fi
    
    - name: Check for unwrap() usage
      run: |
        echo "4ï¸âƒ£ Checking unwrap() usage..."
        unwrap_count=$(grep -r --include="*.rs" '\.unwrap()' . --exclude-dir=target | wc -l || true)
        if [ "$unwrap_count" -gt 10 ]; then
          echo "âŒ Found $unwrap_count instances of .unwrap(). Consider using proper error handling."
          echo "See copilot-instructions.md for error handling best practices"
          grep -r --include="*.rs" '\.unwrap()' . --exclude-dir=target | head -10
          echo "FAILED_CHECKS=${{ env.FAILED_CHECKS }} unwrap-usage" >> $GITHUB_ENV
        else
          echo "âœ… Unwrap usage is reasonable ($unwrap_count instances)"
        fi
    
    - name: Check for lazy variable declaration
      run: |
        echo "5ï¸âƒ£ Checking variable declaration patterns..."
        # Look for functions with multiple let statements at the beginning
        if grep -r --include="*.rs" -A 10 'fn.*{' . --exclude-dir=target | grep -E 'let.*=.*;\s*$' | grep -E 'let.*=.*;\s*let.*=.*;\s*let.*=.*;'; then
          echo "âŒ Found potential early variable declarations. Declare variables when needed."
          echo "See copilot-instructions.md for lazy declaration guidelines"
          echo "FAILED_CHECKS=${{ env.FAILED_CHECKS }} lazy-declaration" >> $GITHUB_ENV
        else
          echo "âœ… Variable declarations look appropriately lazy"
        fi
    
    - name: Check for TODO/FIXME comments
      run: |
        echo "6ï¸âƒ£ Checking for TODO/FIXME comments..."
        todo_count=$(grep -r --include="*.rs" -E '(TODO|FIXME|XXX|HACK)' . --exclude-dir=target | wc -l || true)
        if [ "$todo_count" -gt 0 ]; then
          echo "âš ï¸ Found $todo_count TODO/FIXME comments:"
          grep -r --include="*.rs" -E '(TODO|FIXME|XXX|HACK)' . --exclude-dir=target | head -5
          echo "Consider addressing these before merging"
        else
          echo "âœ… No TODO/FIXME comments found"
        fi
        
    - name: Final validation result
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ -n "${{ env.FAILED_CHECKS }}" ]; then
          echo "âŒ Code quality checks FAILED for:${{ env.FAILED_CHECKS }}"
          echo "Please fix the issues above and re-run the workflow"
          exit 1
        else
          echo "âœ… All code quality checks PASSED!"
          echo "Code follows all guidelines from copilot-instructions.md"
        fi

  security-audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-audit
      run: cargo install cargo-audit
    - name: Run security audit
      run: cargo audit

  performance-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-bloat
      run: cargo install cargo-bloat
    - name: Check binary size
      run: |
        cargo build --release
        cargo bloat --release --crates
